<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Adopt Me Trade Calculator</title>
    <style>
        /* ==========================================================================
           THEME: CANDY POP & CLEAN DEPTH
           ========================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@600;800;900&display=swap');

        :root {
            --bg-body: #f4f7fc;
            --primary-grad: linear-gradient(135deg, #ff7eb3 0%, #ff758c 100%);
            --primary-shadow: 0 8px 20px rgba(255, 117, 140, 0.4);
            --accent-blue: #4facfe;
            --card-bg: #ffffff;
            --card-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
            --text-dark: #2d3436;
            --text-gray: #636e72;
            --border-radius: 24px;
            --slot-bg: #f1f2f6;
            --cols: 4;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Nunito', sans-serif;
            background: var(--bg-body);
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
            /* Prevent horizontal scroll */
        }

        /* CLASS TO LOCK BODY SCROLL WHEN MODAL IS OPEN */
        body.modal-open {
            overflow: hidden !important;
            height: 100vh;
        }

        .bg-decoration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 15% 50%, rgba(255, 126, 179, 0.08), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(79, 172, 254, 0.08), transparent 25%);
            z-index: -1;
            pointer-events: none;
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
            /* Space for mobile scrolling */
        }

        /* ==========================================================================
           HEADER
           ========================================================================== */
        header {
            text-align: center;
            padding: 40px 0 30px;
        }

        h1 {
            margin: 0;
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            font-weight: 900;
            background: var(--primary-grad);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 10px rgba(255, 117, 140, 0.2));
        }

        /* ==========================================================================
           SCOREBOARD
           ========================================================================== */
        .scoreboard-wrap {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 25px;
            margin-bottom: 40px;
        }

        .score-card {
            flex: 1;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: transform 0.3s ease;
        }

        .score-card:hover {
            transform: translateY(-5px);
        }

        .score-label {
            font-size: 0.9rem;
            font-weight: 800;
            color: #b2bec3;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 10px;
        }

        .score-val {
            font-size: clamp(2.5rem, 4vw, 3.5rem);
            font-weight: 900;
            color: var(--text-dark);
            line-height: 1;
            margin-bottom: 15px;
        }

        .score-val.highlight {
            background: var(--primary-grad);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stat-badge {
            background: #f4f7fc;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--text-gray);
        }

        .stat-badge b {
            color: var(--text-dark);
        }

        /* FAIRNESS METER */
        .fairness-card {
            flex: 1.2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 30px;
        }

        .result-pill {
            font-size: 1.8rem;
            font-weight: 900;
            padding: 10px 40px;
            border-radius: 20px;
            background: #f8f9fa;
            color: #dfe6e9;
            margin-bottom: 20px;
            transition: all 0.4s;
        }

        .result-pill.win {
            background: #d4edda;
            color: #27ae60;
            transform: scale(1.1);
        }

        .result-pill.fair {
            background: #fff3cd;
            color: #f39c12;
        }

        .result-pill.lose {
            background: #f8d7da;
            color: #c0392b;
        }

        .meter-track {
            width: 100%;
            height: 18px;
            background: #ecf0f1;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .meter-gradient {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ff7675 0%, #ffeaa7 45%, #ffeaa7 55%, #55efc4 100%);
        }

        .meter-pointer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 26px;
            height: 26px;
            background: #fff;
            border: 5px solid var(--text-dark);
            border-radius: 50%;
            transition: left 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* ==========================================================================
           TRADE GRIDS
           ========================================================================== */
        .trade-row {
            display: flex;
            gap: 30px;
        }

        .trade-panel {
            flex: 1;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 25px;
        }

        .panel-head {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-weight: 900;
            font-size: 1.1rem;
        }

        .slots-grid {
            display: grid;
            grid-template-columns: repeat(var(--cols), 1fr);
            gap: 12px;
        }

        .slot {
            aspect-ratio: 1;
            background: var(--slot-bg);
            border-radius: 18px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .slot.empty {
            background: #fff;
            border: 2px dashed #dfe6e9;
            box-shadow: none;
        }

        .slot.add-ready {
            border: 2px solid #81ecec;
            background: #e0fbfb;
            animation: pulseSlot 2s infinite;
        }

        @keyframes pulseSlot {
            0% {
                border-color: rgba(129, 236, 236, 0.4);
            }

            50% {
                border-color: rgba(129, 236, 236, 1);
            }

            100% {
                border-color: rgba(129, 236, 236, 0.4);
            }
        }

        .add-symbol {
            font-size: 24px;
            color: #dfe6e9;
        }

        .slot.add-ready .add-symbol {
            color: #00cec9;
            font-weight: 900;
        }

        .slot img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }

        .tag-row {
            position: absolute;
            bottom: 4px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 3px;
        }

        .tag {
            font-size: 10px;
            font-weight: 900;
            color: #fff;
            padding: 2px 6px;
            border-radius: 6px;
        }

        .tag.n {
            background: #00d2ff;
        }

        .tag.m {
            background: linear-gradient(45deg, #ff00aa, #ba00ff);
        }

        .tag.f {
            background: #74b9ff;
        }

        .tag.r {
            background: #ff7675;
        }

        .panel-foot {
            margin-top: 20px;
            text-align: right;
            font-size: 1.2rem;
            font-weight: 800;
        }

        /* ==========================================================================
           FIXED SCROLLING DRAWER (MODAL)
           ========================================================================== */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(45, 52, 54, 0.6);
            backdrop-filter: blur(8px);
            z-index: 2000;
            /* High z-index */
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-backdrop.active {
            display: flex;
            opacity: 1;
        }

        .drawer-box {
            width: 1000px;
            max-width: 100%;
            height: 700px;
            max-height: 85vh;
            /* Keep some space around */
            background: #fff;
            border-radius: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            overflow: hidden;
            /* Important: prevents box itself from scrolling */
            position: relative;
        }

        /* SIDEBAR */
        .drawer-sidebar {
            width: 260px;
            background: #f8f9fa;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-right: 1px solid #edf2f7;
            overflow-y: auto;
            /* Allow sidebar to scroll independently if needed */
        }

        .nav-btn {
            width: 100%;
            padding: 14px 20px;
            border: none;
            background: transparent;
            text-align: left;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-gray);
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .nav-btn:hover {
            background: #fff;
            color: var(--accent-blue);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .nav-btn.active {
            background: var(--primary-grad);
            color: #fff;
            box-shadow: var(--primary-shadow);
        }

        /* CONTENT AREA */
        .drawer-content {
            flex: 1;
            padding: 20px 30px;
            display: flex;
            flex-direction: column;
            background: #fff;
            height: 100%;
            /* Full height of parent */
            overflow: hidden;
            /* Stops scroll bubbling */
        }

        .search-wrap {
            flex-shrink: 0;
            /* Prevent search from shrinking */
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border: 2px solid #f1f2f6;
            border-radius: 18px;
            font-size: 1rem;
            font-weight: 700;
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #b2bec3;
        }

        /* THE GRID SCROLL FIX */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 20px;

            /* SCROLL MAGIC */
            flex: 1;
            /* Take all remaining space */
            min-height: 0;
            /* Allow shrinking inside flex container */
            overflow-y: auto;
            /* Scroll vertically */

            padding: 5px;
            padding-right: 10px;
        }

        .items-grid::-webkit-scrollbar {
            width: 6px;
        }

        .items-grid::-webkit-scrollbar-track {
            background: transparent;
        }

        .items-grid::-webkit-scrollbar-thumb {
            background: #dfe6e9;
            border-radius: 10px;
        }

        .item-card {
            background: #fff;
            border: 1px solid #f1f2f6;
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            height: 160px;
            /* Fixed height for consistency */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .item-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .item-img-wrap {
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-img-wrap img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .item-name {
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--text-dark);
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .item-val-badge {
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--accent-blue);
            background: rgba(79, 172, 254, 0.1);
            padding: 2px 8px;
            border-radius: 6px;
            align-self: center;
        }

        .drawer-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: #f1f2f6;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-gray);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drawer-close:hover {
            background: #ff7675;
            color: #fff;
        }

        /* POPUPS */
        .popup {
            background: #fff;
            width: 400px;
            max-width: 90%;
            border-radius: 30px;
            padding: 35px;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s;
        }

        .modal-backdrop.active .popup {
            transform: scale(1);
            opacity: 1;
        }

        .option-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .group-label {
            font-size: 0.8rem;
            font-weight: 800;
            color: #b2bec3;
            text-transform: uppercase;
            margin-bottom: 10px;
            display: block;
        }

        .pills-row {
            display: flex;
            gap: 10px;
        }

        .check-pill {
            flex: 1;
            position: relative;
        }

        .check-pill input {
            display: none;
        }

        .check-pill span {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 45px;
            border: 2px solid #f1f2f6;
            border-radius: 12px;
            font-weight: 800;
            color: var(--text-gray);
            cursor: pointer;
            transition: 0.2s;
        }

        .check-pill input:checked+span {
            border-color: transparent;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .c-neon input:checked+span {
            background: #00d2ff;
        }

        .c-mega input:checked+span {
            background: linear-gradient(135deg, #ff00aa, #ba00ff);
        }

        .c-reg input:checked+span {
            background: var(--text-dark);
        }

        .c-fly input:checked+span {
            background: #74b9ff;
        }

        .c-ride input:checked+span {
            background: #ff7675;
        }

        .action-row {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-weight: 800;
            cursor: pointer;
        }

        .btn-ghost {
            background: #f1f2f6;
            color: var(--text-gray);
        }

        .btn-fill {
            background: var(--primary-grad);
            color: #fff;
            box-shadow: var(--primary-shadow);
        }

        .qty-ctrl {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .qty-btn {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            border: none;
            background: #f1f2f6;
            font-size: 1.5rem;
            font-weight: 900;
            cursor: pointer;
        }

        .qty-val {
            font-size: 2.5rem;
            font-weight: 900;
            width: 80px;
            text-align: center;
            border: none;
            color: var(--text-dark);
        }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .scoreboard-wrap {
                flex-wrap: wrap;
            }

            .fairness-card {
                order: -1;
                width: 100%;
                flex: none;
            }
        }

        @media (max-width: 768px) {
            :root {
                --cols: 4;
            }

            .drawer-box {
                flex-direction: column;
                height: 95vh;
                max-height: 95vh;
            }

            .drawer-sidebar {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                padding: 15px;
                border-right: none;
                border-bottom: 1px solid #f1f2f6;
                flex-shrink: 0;
                height: 70px;
            }

            .nav-btn {
                width: auto;
                white-space: nowrap;
                padding: 8px 20px;
                border-radius: 50px;
                background: #fff;
                border: 1px solid #f1f2f6;
            }

            .nav-btn.active {
                border-color: transparent;
            }

            .trade-row {
                flex-direction: column;
            }

            h1 {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            :root {
                --cols: 3;
            }

            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>

<body>

    <div class="bg-decoration"></div>

    <div class="wrap">

        <div class="scoreboard-wrap">
            <div class="score-card">
                <div class="score-label">You Give</div>
                <div class="score-val highlight" id="your-score">0.00</div>
                <div class="stats-row">
                    <div class="stat-badge">Frosts: <b id="your-frosts">0</b></div>
                    <div class="stat-badge">Sharks: <b id="your-sharks">0</b></div>
                </div>
            </div>
            <div class="fairness-card">
                <div class="result-pill fair" id="result-indicator">FAIR</div>
                <div class="meter-track">
                    <div class="meter-gradient"></div>
                    <div class="meter-pointer" id="fair-pointer"></div>
                </div>
            </div>
            <div class="score-card">
                <div class="score-label">They Give</div>
                <div class="score-val highlight" id="their-score">0.00</div>
                <div class="stats-row">
                    <div class="stat-badge">Frosts: <b id="their-frosts">0</b></div>
                    <div class="stat-badge">Sharks: <b id="their-sharks">0</b></div>
                </div>
            </div>
        </div>

        <div class="trade-row">
            <div class="trade-panel">
                <div class="panel-head"><span>Your Offer</span><span>Max 18</span></div>
                <div class="slots-grid" id="your-grid"></div>
                <div class="panel-foot">Total: <span id="your-total">0.00</span></div>
            </div>
            <div class="trade-panel">
                <div class="panel-head"><span>Their Offer</span><span>Max 18</span></div>
                <div class="slots-grid" id="their-grid"></div>
                <div class="panel-foot">Total: <span id="their-total">0.00</span></div>
            </div>
        </div>
    </div>

    <!-- DRAWER MODAL -->
    <div class="modal-backdrop" id="drawer-overlay">
        <div class="drawer-box">
            <button class="drawer-close" id="drawer-close">&times;</button>
            <aside class="drawer-sidebar" id="drawer-categories-list"></aside>
            <div class="drawer-content">
                <div class="search-wrap">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="drawer-search" placeholder="Search for pets..." />
                </div>
                <div class="items-grid" id="drawer-items"></div>
            </div>
        </div>
    </div>

    <!-- PET OPTIONS -->
    <div class="modal-backdrop" id="pet-options-modal">
        <div class="popup">
            <h3 id="pet-options-title">Customize Pet</h3>
            <div class="option-group">
                <span class="group-label">Type</span>
                <div class="pills-row">
                    <label class="check-pill c-reg"><input type="radio" name="pet_version" value="rvalue"
                            checked><span>Normal</span></label>
                    <label class="check-pill c-neon"><input type="radio" name="pet_version"
                            value="nvalue"><span>Neon</span></label>
                    <label class="check-pill c-mega"><input type="radio" name="pet_version"
                            value="mvalue"><span>Mega</span></label>
                </div>
            </div>
            <div class="option-group">
                <span class="group-label">Potions</span>
                <div class="pills-row">
                    <label class="check-pill c-fly"><input type="checkbox" id="check-fly"><span>Fly</span></label>
                    <label class="check-pill c-ride"><input type="checkbox" id="check-ride"><span>Ride</span></label>
                </div>
            </div>
            <div class="action-row">
                <button class="btn btn-ghost" id="pet-options-cancel">Cancel</button>
                <button class="btn btn-fill" id="pet-options-confirm">Next</button>
            </div>
        </div>
    </div>

    <!-- QUANTITY -->
    <div class="modal-backdrop" id="quantity-modal">
        <div class="popup">
            <h3 id="quantity-title">Quantity</h3>
            <div class="qty-ctrl">
                <button class="qty-btn" id="qty-minus">-</button>
                <input type="text" class="qty-val" id="qty-number" value="1" readonly />
                <button class="qty-btn" id="qty-plus">+</button>
            </div>
            <div class="action-row">
                <button class="btn btn-ghost" id="qty-cancel">Cancel</button>
                <button class="btn btn-fill" id="qty-confirm">Add</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let FROST_VALUE = 160.0;
            let SHARK_VALUE = 1.0;
            const MAX_SLOTS = 18;
            let allData = [], categories = [], activeCategory = "", activeGrid = null, selectedItem = null, selectedPetConfig = null;

            const dom = {
                yourGrid: document.getElementById("your-grid"),
                theirGrid: document.getElementById("their-grid"),
                yourTotal: document.getElementById("your-total"),
                theirTotal: document.getElementById("their-total"),
                yourScore: document.getElementById("your-score"),
                theirScore: document.getElementById("their-score"),
                yourFrosts: document.getElementById("your-frosts"),
                yourSharks: document.getElementById("your-sharks"),
                theirFrosts: document.getElementById("their-frosts"),
                theirSharks: document.getElementById("their-sharks"),
                fairPointer: document.getElementById("fair-pointer"),
                fairIndicator: document.getElementById("result-indicator"),
                drawerOverlay: document.getElementById("drawer-overlay"),
                drawerItems: document.getElementById("drawer-items"),
                drawerSearch: document.getElementById("drawer-search"),
                drawerCats: document.getElementById("drawer-categories-list"),
                drawerClose: document.getElementById("drawer-close"),
                petModal: document.getElementById("pet-options-modal"),
                petTitle: document.getElementById("pet-options-title"),
                petConfirm: document.getElementById("pet-options-confirm"),
                petCancel: document.getElementById("pet-options-cancel"),
                checkFly: document.getElementById("check-fly"),
                checkRide: document.getElementById("check-ride"),
                qtyModal: document.getElementById("quantity-modal"),
                qtyTitle: document.getElementById("quantity-title"),
                qtyInput: document.getElementById("qty-number"),
                qtyPlus: document.getElementById("qty-plus"),
                qtyMinus: document.getElementById("qty-minus"),
                qtyConfirm: document.getElementById("qty-confirm"),
                qtyCancel: document.getElementById("qty-cancel")
            };

            async function init() {
                try {
                    const [d, g] = await Promise.all([fetch('data.json'), fetch('Gag.json')]);
                    if (!d.ok || !g.ok) throw new Error("Files missing");
                    const rawD = await d.json(); const rawG = await g.json();
                    const proc = (o) => Object.values(o).map(i => ({ ...i, value: i.value || i.rvalue || 0 }));
                    allData = [...proc(rawD), ...proc(rawG)];
                    const frost = allData.find(i => i.name === "Frost Dragon");
                    if (frost) FROST_VALUE = frost.rvalue || 160;
                    const types = new Set(allData.map(i => i.type).filter(Boolean));
                    categories = Array.from(types).sort();
                    activeCategory = categories.includes('pets') ? 'pets' : categories[0];
                    setupUI();
                } catch (e) {
                    allData = [
                        { name: "Frost Dragon", type: "pets", rvalue: 160, image: "https://static.wikia.nocookie.net/adoptme/images/8/82/Frost_Dragon.png", nvalue: 500, mvalue: 1500 },
                        { name: "Shadow Dragon", type: "pets", rvalue: 250, image: "https://static.wikia.nocookie.net/adoptme/images/e/e0/Shadow_Dragon.png", nvalue: 800, mvalue: 2500 },
                        { name: "Sandwich", type: "food", value: 0.1, image: "https://static.wikia.nocookie.net/adoptme/images/9/9e/Sandwich.png" }
                    ];
                    categories = ['pets', 'food']; activeCategory = 'pets'; setupUI();
                }
            }

            function setupUI() {
                dom.drawerCats.innerHTML = ``;
                categories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = 'nav-btn';
                    btn.textContent = cat.replace(/_/g, ' ');
                    if (cat === activeCategory) btn.classList.add('active');
                    btn.onclick = () => {
                        activeCategory = cat;
                        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        renderDrawerItems();
                    };
                    dom.drawerCats.appendChild(btn);
                });
                [dom.yourGrid, dom.theirGrid].forEach(g => {
                    g.innerHTML = '';
                    for (let i = 0; i < MAX_SLOTS; i++) {
                        const s = document.createElement('div'); s.className = 'slot empty';
                        s.innerHTML = `<span class="add-symbol">+</span>`;
                        g.appendChild(s);
                    }
                    updateGridState(g);
                });
                setupEvents();
            }

            function setupEvents() {
                const close = () => {
                    dom.drawerOverlay.classList.remove('active');
                    document.body.classList.remove('modal-open'); // UNLOCK SCROLL
                };
                dom.drawerClose.onclick = close;
                dom.drawerOverlay.onclick = (e) => { if (e.target === dom.drawerOverlay) close(); };
                dom.drawerSearch.oninput = renderDrawerItems;
                dom.petCancel.onclick = () => { dom.petModal.classList.remove('active'); document.body.classList.remove('modal-open'); };
                dom.petConfirm.onclick = confirmPetOptions;
                dom.qtyCancel.onclick = () => { dom.qtyModal.classList.remove('active'); document.body.classList.remove('modal-open'); };
                dom.qtyMinus.onclick = () => dom.qtyInput.value = Math.max(1, parseInt(dom.qtyInput.value) - 1);
                dom.qtyPlus.onclick = () => dom.qtyInput.value = Math.min(MAX_SLOTS, parseInt(dom.qtyInput.value) + 1);
                dom.qtyConfirm.onclick = confirmQty;
            }

            function openDrawer(grid) {
                activeGrid = grid;
                dom.drawerOverlay.classList.add('active');
                document.body.classList.add('modal-open'); // LOCK SCROLL
                dom.drawerSearch.value = '';
                renderDrawerItems();
            }

            function renderDrawerItems() {
                const q = dom.drawerSearch.value.toLowerCase();
                const f = allData.filter(i => i.type === activeCategory && i.name.toLowerCase().includes(q)).sort((a, b) => (b.value || 0) - (a.value || 0));
                dom.drawerItems.innerHTML = '';
                f.forEach(item => {
                    const d = document.createElement('div'); d.className = 'item-card';
                    d.innerHTML = `<div class="item-img-wrap"><img src="${item.image}" loading="lazy"></div><div class="item-name">${item.name}</div><div class="item-val-badge">${(item.value || 0).toFixed(1)}</div>`;
                    d.onclick = () => selectItem(item);
                    dom.drawerItems.appendChild(d);
                });
            }

            function selectItem(item) {
                selectedItem = item;
                dom.drawerOverlay.classList.remove('active');
                // Keep body locked because we open another modal immediately
                if (item.type === 'pets') {
                    document.querySelector('input[name="pet_version"][value="rvalue"]').checked = true;
                    dom.checkFly.checked = false; dom.checkRide.checked = false;
                    dom.petTitle.textContent = item.name;
                    dom.petModal.classList.add('active');
                } else {
                    selectedPetConfig = null; openQty();
                }
            }

            function confirmPetOptions() {
                const v = document.querySelector('input[name="pet_version"]:checked').value;
                selectedPetConfig = { version: v, isFly: dom.checkFly.checked, isRide: dom.checkRide.checked };
                dom.petModal.classList.remove('active');
                openQty();
            }

            function openQty() {
                dom.qtyTitle.textContent = selectedItem.name;
                dom.qtyInput.value = 1;
                dom.qtyModal.classList.add('active');
            }

            function confirmQty() {
                const qty = parseInt(dom.qtyInput.value);
                dom.qtyModal.classList.remove('active');
                document.body.classList.remove('modal-open'); // UNLOCK SCROLL

                let val = selectedItem.value || 0, tags = '';
                if (selectedPetConfig) {
                    const { version, isFly, isRide } = selectedPetConfig;
                    let pk = ""; if (isFly && isRide) pk = "fly&ride"; else if (isFly) pk = "fly"; else if (isRide) pk = "ride"; else pk = "nopotion";
                    let lk = version; if (pk !== "nopotion") lk += ` - ${pk}`; else if (selectedItem[`${version} - nopotion`]) lk = `${version} - nopotion`;
                    if (selectedItem[lk] !== undefined) val = selectedItem[lk]; else if (selectedItem[version] !== undefined) val = selectedItem[version];
                    if (version === 'nvalue') tags += `<span class="tag n">N</span>`;
                    if (version === 'mvalue') tags += `<span class="tag m">M</span>`;
                    if (isFly) tags += `<span class="tag f">F</span>`;
                    if (isRide) tags += `<span class="tag r">R</span>`;
                }
                addItems(activeGrid, selectedItem, val, qty, tags);
            }

            function addItems(grid, item, val, qty, tags) {
                const empty = Array.from(grid.children).filter(s => s.classList.contains('empty'));
                const count = Math.min(qty, empty.length);
                for (let i = 0; i < count; i++) {
                    const s = empty[i]; s.className = 'slot filled'; s.dataset.value = val;
                    s.innerHTML = `<img src="${item.image}"><div class="tag-row">${tags}</div>`;
                    s.onclick = () => {
                        s.className = 'slot empty'; s.dataset.value = 0; s.innerHTML = `<span class="add-symbol">+</span>`;
                        s.onclick = null; updateGridState(grid); calculate();
                    };
                }
                updateGridState(grid); calculate();
            }

            function updateGridState(grid) {
                const slots = Array.from(grid.children); let found = false;
                slots.forEach(s => {
                    s.classList.remove('add-ready');
                    if (s.classList.contains('empty')) {
                        s.onclick = null;
                        if (!found) { found = true; s.classList.add('add-ready'); s.onclick = () => openDrawer(grid); }
                    }
                });
            }

            function calculate() {
                const sum = (g) => Array.from(g.children).reduce((a, b) => a + (parseFloat(b.dataset.value) || 0), 0);
                const v1 = sum(dom.yourGrid), v2 = sum(dom.theirGrid);
                dom.yourTotal.textContent = v1.toFixed(2); dom.theirTotal.textContent = v2.toFixed(2);
                dom.yourScore.textContent = v1.toFixed(2); dom.theirScore.textContent = v2.toFixed(2);
                dom.yourFrosts.textContent = (v1 / FROST_VALUE).toFixed(2); dom.yourSharks.textContent = (v1 / SHARK_VALUE).toFixed(2);
                dom.theirFrosts.textContent = (v2 / FROST_VALUE).toFixed(2); dom.theirSharks.textContent = (v2 / SHARK_VALUE).toFixed(2);

                const t = v1 + v2; let pct = 50, s = "FAIR", sc = "fair";
                if (t > 0) pct = (v2 / t) * 100; pct = Math.max(5, Math.min(95, pct));
                dom.fairPointer.style.left = `${pct}%`;
                if (t > 0) {
                    const d = v2 - v1, r = Math.abs(d) / Math.max(v1, v2);
                    if (r > 0.1) { if (d > 0) { s = "WIN"; sc = "win"; } else { s = "LOSE"; sc = "lose"; } }
                }
                dom.fairIndicator.textContent = s; dom.fairIndicator.className = `result-pill ${sc}`;
            }

            init();
        });
    </script>
</body>

</html>